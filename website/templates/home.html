{% extends "base.html" %}
{% block title %}Home{% endblock %}

{% block content %}


<form id="routeForm">



    <div class="form-row">
        <div class="form-group col-md-4">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">
                        <i class="fa fa-plane"></i> <!-- Assuming you're using Font Awesome for icons -->
                    </span>
                </div>
                <input type="text" class="form-control suggestionField icon-input" list="suggestionsOrigin" id="origin"
                    placeholder="From">
            </div>
            <datalist id="suggestionsOrigin"></datalist>
        </div>



        <div class="form-group col-md-4">

            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">
                        <i class="fa fa-plane"></i> <!-- Assuming you're using Font Awesome for icons -->
                    </span>
                </div>
                <input type="text" class="form-control suggestionField icon-input" list="suggestionsDest"
                    id="destination" placeholder="To">
            </div>
            <datalist id="suggestionsDest"></datalist>
        </div>

        <div class="form-group col-md-3">

            <div class="input-group">
                <input type="date" class="form-control" id="departure_date" placeholder="Select Date" autocomplete="on">
            </div>


            <!-- <input type="date" class="form-control" id="departure_date"> -->
        </div>
        <div class="form-group col-md-1">

            <div class="input-group">
                <input type="hidden" id="sortOrder" name="sortOrder">
                <button class="btn btn-outline-secondary" type="button" id="filterBtn">
                    <i class="fa fa-filter"></i>
                </button>
            </div>
            <br>
        </div>
    </div>
    </div>
    </div>

    <div class="form-row">








        <div id="popover-content" style="display: none;">
            <div class="list-group">
                <button type="button" class="list-group-item list-group-item-action sort-option"
                    data-value="ascending">Distance Ascending</button>
                <button type="button" class="list-group-item list-group-item-action sort-option"
                    data-value="descending">Distance Descending</button>
            </div>
        </div>


    </div>














    <div class="form-group row">
        <div class="form-group col-md-10">
            <div class="form-check">
                <input type="checkbox" id="direct_flight" name="direct_flight" value="true">
                <label for="direct_flight">Direct Flight Only</label><br>
            </div>
        </div>
        <div class="form-group col-md-2">
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </div>




</form>




<div class=" mt-3 mb-3">

    <div id="allOutput">
        <div id="optimalRouteOutput"></div>
        <div id="output"></div>

    </div>


    <script>

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("filterBtn").addEventListener("click", function () {
                // Show the popover
                var filterBtn = this;
                var popoverContent = document.getElementById("popover-content").innerHTML;
                filterBtn.setAttribute("data-toggle", "popover");
                filterBtn.setAttribute("data-content", popoverContent);
                filterBtn.setAttribute("data-html", "true");
                filterBtn.setAttribute("data-placement", "bottom");
                $(filterBtn).popover('toggle');
            });

            // Update the hidden input field when an option is clicked
            document.addEventListener("click", function (event) {
                if (event.target.classList.contains("sort-option")) {
                    var sortOrder = event.target.getAttribute("data-value");
                    document.getElementById("sortOrder").value = sortOrder;
                }
            });
        });

        document.addEventListener('click', function (event) {
            var popover = document.getElementById('suggestionsOrigin');
            var originInput = document.getElementById('origin');

            // Check if the click target is inside the popover or the input field
            if (!popover.contains(event.target) && event.target !== originInput) {
                // If click is outside popover and input field, close the popover
                popover.innerHTML = ''; // Clear popover content
            }
        });


        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("origin").addEventListener("input", function () {
                console.log("Input event fired origin");
                var prefixValue = this.value;
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/suggest?prefix=" + prefixValue, true);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        var data = JSON.parse(xhr.responseText);
                        console.log(data)
                        var suggestionsElement2 = document.getElementById("suggestionsOrigin");
                        suggestionsElement2.innerHTML = ""; // Clear the datalist
                        data.forEach(function (suggestion) {
                            var option = document.createElement("option");
                            option.value = suggestion;
                            suggestionsElement2.appendChild(option); // Add each suggestion to the datalist
                        });
                    }
                };
                xhr.send();
            });

            document.getElementById("destination").addEventListener("input", function () {
                console.log("Input event fired dest");
                var prefixValue = this.value;
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/suggest?prefix=" + prefixValue, true);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        var data = JSON.parse(xhr.responseText);
                        console.log(data)
                        var suggestionsElement = document.getElementById("suggestionsDest");
                        suggestionsElement.innerHTML = ""; // Clear the datalist
                        data.forEach(function (suggestion) {
                            var option = document.createElement("option");
                            option.value = suggestion;
                            suggestionsElement.appendChild(option); // Add each suggestion to the datalist
                        });
                    }
                };
                xhr.send();
            });


        });

        document.getElementById('routeForm').addEventListener('submit', function (event) {
            event.preventDefault();
            var output = document.getElementById('output');
            output.innerHTML = '<p>Searching for results...</p>';

            var optimalRouteOutput = document.getElementById('optimalRouteOutput');
            optimalRouteOutput.innerHTML = '';


            var form = event.target;
            var origin = form.elements.origin.value;
            var destination = form.elements.destination.value;
            var departureDate = form.elements.departure_date.value;
            var directFlight = form.elements.direct_flight.checked;
            var sortOrder = form.elements.sortOrder.value;

            var searchData = {
                origin: origin,
                destination: destination,
                departure_date: departureDate,
                direct_flight: directFlight,
                sortOrder: sortOrder
            };

            // Send data to backend for processing
            fetch('/get_route', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(searchData)
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    console.log(data[0])
                    output.innerHTML = '';
                    var optimalRouteOutput = document.getElementById('optimalRouteOutput');

                    output.innerHTML = ''; // 
                    optimalRouteOutput.innerHTML = ''; // Clear the output div


                    if (data[1].hasOwnProperty('optimal_route_data')) {
                        console.log("True")
                        console.log(data[1])


                        var route = data[1].optimal_route_data


                        var routeInfo = ""
                        for (let j = 0; j < route[0][0].length; j++) {

                            console.log(route[0][0][j])

                            routeInfo += route[0][0][j];
                            if (j < route[0][0][j].length - 2) {
                                routeInfo += ' -> '

                            }

                        }


                        var codeBlock = `<div class="card w-50 mb-2">
                                    <div class="card-body">
                                        <span class="badge badge-info">Best Optimal</span>
                                    <h5 class="card-title">Source Airport: ${route[0][0][0]}</h5>
                                    <h5 class="card-title">Destination Airport: ${route[0][0][1]}</h5>
                                    <p class="card-text">Distance: ${route[0][2]} km</p>
                                    <p class="card-text">Airline: ${route[0][1]} </p>
                                    <p class="card-text">Price: $${route[0][3]} </p>
                                    <p class="card-text">Route: ${routeInfo}</p>

                                    <a href="#" class="btn btn-primary">View More</a>
                                    </div>
                                    </div>`;


                        optimalRouteOutput.innerHTML += codeBlock












                    }





                    if (data[0].hasOwnProperty('direct_flight_data')) {
                        console.log("Ttue")
                        if (data[0].direct_flight_data.length > 0) {

                            for (i = 0; i < data[0].direct_flight_data.length; i++) {
                                var route = data[0].direct_flight_data[i]

                                var routeInfo = ""
                                for (let j = 0; j < route[0].length; j++) {

                                    console.log(route[0][j])

                                    routeInfo += route[0][j];
                                    if (j < route[0][j].length - 2) {
                                        routeInfo += ' -> '

                                    }

                                }


                                var codeBlock = `<div class="card w-50 mb-2">
                                    <div class="card-body">
                                    <h5 class="card-title">Source Airport: ${route[0][0][0]}</h5>
                                    <h5 class="card-title">Destination Airport: ${route[0][1]}</h5>
                                    <p class="card-text">Distance: ${route[1]} km</p>
                                    <p class="card-text">Airline: ${route[2]} </p>
                                    <p class="card-text">Price: $${route[3]} </p>
                                    <p class="card-text">Route: ${routeInfo}</p>

                                    <a href="#" class="btn btn-primary">View More</a>
                                    </div>
                                    </div>`;


                                output.innerHTML += codeBlock





                            }




                        }


                    }

                    else if (data.hasOwnProperty('error')) {
                        output.innerHTML += `<p>${data.error}</p>`

                    }
                    else {
                        console.log("False")
                        if (data[0].indirect_flight_data.length > 0) {

                            for (i = 0; i < data[0].indirect_flight_data.length; i++) {
                                var route = data[0].indirect_flight_data[i]
                                console.log("---------------------------------------")
                                console.log(route)
                                console.log("---------------------------------------")
                                var routeInfo = ""
                                for (let j = 0; j < route[0].length; j++) {

                                    console.log(route[0][j])

                                    routeInfo += route[0][j];
                                    if (j < route[0][j].length - 1) {
                                        routeInfo += ' -> '

                                    }

                                }

                                var codeBlock = `<div class="card w-50 mb-2">
                                <div class="card-body">
                                <h5 class="card-title">Source Airport: ${route[0][0]}</h5>
                                <h5 class="card-title">Destination Airport: ${route[0][1]}</h5>
                                <p class="card-text">Distance: ${route[1]} km</p>
                                <p class="card-text">Airline: ${route[2]} </p>
                                <p class="card-text">Price: $${route[3]} </p>
                                <p class="card-text">Route: ${routeInfo}</p>

                                <a href="#" class="btn btn-primary">View More</a>
                                </div>
                                </div>`;


                                output.innerHTML += codeBlock





                            }




                        }




                    }







                }
                )
                .catch(error => {
                    console.error('Error:', error);
                    // Handle error
                });
        });
    </script>

    <style>
        div#allOutput {
            margin-left: 5rem;
        }

        form#routeForm {
            margin-top: 4em;
        }

        .input-group-text {
            background-color: #fff !important;
        }

        input#origin,
        input#destination {
            border-left: 0px solid;
        }

        .form-check {
            margin-left: 4em;
        }
    </style>


    {% endblock %}